#  Copyright (c) 2015-2021 Patrick Diehl
#
#  Distributed under the Boost Software License, Version 1.0. (See accompanying
#  file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
version: 2

jobs:
    build:
      docker:
          - image: fedora:33
      working_directory: /hpx/
      steps:
       - checkout
       - run:
           name: Install dependencies
           command: dnf update -y && dnf install -y xsltproc doxygen libpng-dev wget hpx-devel kernel-devel-$(uname -r) kernel-headers-$(uname -r)
       - run: 
           name: Install cuda
           command: |
                wget https://developer.download.nvidia.com/compute/cuda/11.2.2/local_installers/cuda_11.2.2_460.32.03_linux.run && \
                chmod +x cuda_11.2.2_460.32.03_linux.run && \
                ./cuda_11.2.2_460.32.03_linux.run --toolkit --silent && \
                rm cuda_11.2.2_460.32.03_linux.run
       - run:
           name: Create build folder
           command: cd /hpx && mkdir -p build
       - run: 
           name: Configure
           command: cd /hpx/build && cmake .. -DCMAKE_BUILD_TYPE=Debug -DHPX_WITH_MALLOC=system -DCMAKE_CXX_FLAGS="-fcolor-diagnostics" -DHPXCL_WITH_OPENCL=OFF -DHPXCL_WITH_CUDA=On  -DHPXCL_WITH_BENCHMARK=On -DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-8.0
       - run: 
           name: Build
           command: cd /hpx/build && make -j 2
       - save_cache:
           key: build-{{ .Branch }}-{{ .Revision }}
           paths:
              - "/hpx"
    
    test:
      docker:
       - image: stellargroup/hpx:dev
      working_directory: /hpx/
      steps:
       - checkout
       - restore_cache:
          key:  build-{{ .Branch }}-{{ .Revision }}
       - run:
          name: Run tests
          command:  cd /hpx/build && ../tools/run_tests.sh
       
workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - test:
          requires:
            - build
          filters:
            branches:
              ignore:
                 - gh-pages
